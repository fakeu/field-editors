{"version":3,"file":"field-editor-validation-errors.cjs.development.js","sources":["../src/styles.ts","../src/ValidationErrors.tsx"],"sourcesContent":["import { css } from 'emotion';\nimport tokens from '@contentful/f36-tokens';\n\nexport const errorList = css({\n  padding: 0,\n  wordWrap: 'break-word',\n  marginTop: tokens.spacingS,\n  color: tokens.red500,\n  listStyleType: 'none',\n});\n\nexport const errorMessage = css({\n  display: 'inline-flex',\n  flexDirection: 'column',\n  marginLeft: tokens.spacingXs,\n});\n\nexport const errorItem = css({\n  display: 'flex',\n  alignItems: 'center',\n});\n\nexport const entryLink = css({\n  fontWeight: Number(tokens.fontWeightDemiBold),\n});\n","import React from 'react';\nimport { ValidationError, Link } from '@contentful/app-sdk';\nimport type {\n  SpaceAPI,\n  Entry,\n  ContentType,\n  FieldAPI,\n  LocalesAPI,\n} from '@contentful/field-editor-shared';\nimport { entityHelpers } from '@contentful/field-editor-shared';\n\nimport * as styles from './styles';\n\nimport { TextLink, List, ListItem } from '@contentful/f36-components';\n\nimport { ExternalLinkIcon, InfoCircleIcon } from '@contentful/f36-icons';\n\ntype UniquenessErrorProps = {\n  error: ValidationError;\n  space: SpaceAPI;\n  localeCode: string;\n  defaultLocaleCode: string;\n  getEntryURL: (entry: Entry) => string;\n};\n\nfunction UniquenessError(props: UniquenessErrorProps) {\n  const [state, setState] = React.useState<{\n    loading: boolean;\n    entries: { id: string; title: string; href: string }[];\n  }>({\n    loading: true,\n    entries: [],\n  });\n\n  const contentTypesById = React.useMemo(\n    (): Record<string, ContentType> =>\n      // Maps ID => Content Type\n      props.space.getCachedContentTypes().reduce(\n        (prev, ct) => ({\n          ...prev,\n          [ct.sys.id]: ct,\n        }),\n        {}\n      ),\n    [props.space]\n  );\n\n  const getTitle = React.useCallback(\n    (entry: Entry) =>\n      entityHelpers.getEntryTitle({\n        entry,\n        defaultTitle: 'Untitled',\n        localeCode: props.localeCode,\n        defaultLocaleCode: props.defaultLocaleCode,\n        contentType: contentTypesById[entry.sys.contentType.sys.id],\n      }),\n    [props.localeCode, props.defaultLocaleCode, contentTypesById]\n  );\n\n  let conflicting: Link<'Entry', 'Link'>[] = [];\n  if ('conflicting' in props.error) {\n    conflicting = props.error.conflicting;\n  }\n  React.useEffect(() => {\n    const entryIds = state.entries.map((entry) => entry.id);\n    const conflictIds = conflicting.map((entry) => entry.sys.id);\n\n    // Avoid unnecessary refetching\n    if (conflictIds.every((id) => entryIds.includes(id))) {\n      return;\n    }\n\n    setState((state) => ({ ...state, loading: true }));\n\n    const query = {\n      'sys.id[in]': conflictIds.join(','),\n    };\n\n    props.space.getEntries<Entry>(query).then(({ items }) => {\n      const entries = items.map((entry) => ({\n        id: entry.sys.id,\n        title: getTitle(entry),\n        href: props.getEntryURL(entry),\n      }));\n\n      setState({\n        loading: false,\n        entries,\n      });\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps -- TODO: Evaluate these dependencies\n  }, [getTitle, state.entries, conflicting, props.space.getEntries, props.getEntryURL]);\n\n  return (\n    <List className={styles.errorList} testId=\"validation-errors-uniqueness\">\n      <ListItem className={styles.entryLink}>\n        {state.loading ? (\n          <div>Loading title for conflicting entryâ€¦</div>\n        ) : (\n          state.entries.map((entry) => (\n            <TextLink\n              key={entry.id}\n              href={entry.href}\n              icon={<ExternalLinkIcon />}\n              alignIcon=\"end\"\n              variant=\"negative\"\n              target=\"_blank\"\n              rel=\"noopener noreferrer\">\n              {entry.title}\n            </TextLink>\n          ))\n        )}\n      </ListItem>\n    </List>\n  );\n}\n\nexport interface ValidationErrorsProps {\n  field: FieldAPI;\n  space: SpaceAPI;\n  locales: LocalesAPI;\n  getEntryURL: (entry: Entry) => string;\n}\n\nexport function ValidationErrors(props: ValidationErrorsProps) {\n  const [errors, setErrors] = React.useState<ValidationError[]>([]);\n\n  React.useEffect(() => {\n    const onErrors = (errors?: ValidationError[]) => {\n      setErrors(errors || []);\n    };\n\n    return props.field.onSchemaErrorsChanged(onErrors);\n  }, [props.field]);\n\n  if (errors.length === 0) {\n    return null;\n  }\n\n  return (\n    <List className={styles.errorList} testId=\"validation-errors\">\n      {errors.map((error, index) => {\n        return (\n          <li\n            key={index}\n            role=\"status\"\n            aria-roledescription=\"field-locale-schema\"\n            data-error-code={`entry.schema.${error.name}`}\n            className={styles.errorItem}>\n            <InfoCircleIcon variant=\"negative\" />\n            <div className={styles.errorMessage}>\n              {error.message}\n              {error.name === 'unique' && (\n                <UniquenessError\n                  error={error}\n                  space={props.space}\n                  localeCode={props.field.locale}\n                  defaultLocaleCode={props.locales.default}\n                  getEntryURL={props.getEntryURL}\n                />\n              )}\n            </div>\n          </li>\n        );\n      })}\n    </List>\n  );\n}\n"],"names":["errorList","css","padding","wordWrap","marginTop","tokens","spacingS","color","red500","listStyleType","errorMessage","display","flexDirection","marginLeft","spacingXs","errorItem","alignItems","entryLink","fontWeight","Number","fontWeightDemiBold","UniquenessError","props","React","useState","loading","entries","state","setState","contentTypesById","useMemo","space","getCachedContentTypes","reduce","prev","ct","sys","id","getTitle","useCallback","entry","entityHelpers","getEntryTitle","defaultTitle","localeCode","defaultLocaleCode","contentType","conflicting","error","useEffect","entryIds","map","conflictIds","every","includes","query","join","getEntries","then","items","title","href","getEntryURL","List","className","styles","testId","ListItem","TextLink","key","icon","ExternalLinkIcon","alignIcon","variant","target","rel","ValidationErrors","errors","setErrors","onErrors","field","onSchemaErrorsChanged","length","index","role","name","InfoCircleIcon","message","locale","locales"],"mappings":"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"}