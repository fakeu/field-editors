{"version":3,"file":"field-editor-json.cjs.production.min.js","sources":["../src/JsonEditorField.tsx","../src/JsonEditorToolbar.tsx","../src/JsonInvalidStatus.tsx","../src/utils.ts","../src/JsonEditor.tsx"],"sourcesContent":["import React from 'react';\n\nimport { json } from '@codemirror/lang-json';\nimport { EditorView } from '@codemirror/view';\nimport tokens from '@contentful/f36-tokens';\nimport CodeMirror from '@uiw/react-codemirror';\nimport { css, cx } from 'emotion';\n\ntype JsonEditorFieldProps = {\n  isDisabled: boolean;\n  value: string;\n  onChange: (value: string) => void;\n};\n\nconst styles = {\n  root: css({\n    cursor: 'text',\n    padding: tokens.spacingS,\n    border: `1px solid ${tokens.gray200}`,\n    borderTop: 'none',\n    borderBottomLeftRadius: tokens.borderRadiusSmall,\n    borderBottomRightRadius: tokens.borderRadiusSmall,\n    fontSize: tokens.fontSizeM,\n    '.cm-editor': {\n      color: tokens.gray900,\n      '&.cm-focused': {\n        outline: 'none',\n      },\n    },\n    '.cm-scroller': {\n      fontFamily: tokens.fontStackMonospace,\n      minHeight: '6rem',\n    },\n    '&.disabled': {\n      cursor: 'auto',\n      '.cm-scroller ': {\n        minHeight: '6rem',\n        backgroundColor: tokens.gray100,\n        cursor: 'not-allowed',\n      },\n      '.cm-editor': {\n        border: `1px solid ${tokens.gray200}`,\n      },\n      '.cm-line': {\n        cursor: 'not-allowed',\n      },\n      '.cm-lines': {\n        cursor: 'not-allowed',\n      },\n    },\n  }),\n};\n\nexport function JsonEditorField(props: JsonEditorFieldProps) {\n  return (\n    <div\n      className={cx(styles.root, { disabled: props.isDisabled })}\n      data-test-id=\"json-editor-code-mirror\"\n    >\n      <CodeMirror\n        value={props.value}\n        onChange={props.onChange}\n        theme=\"light\"\n        extensions={[json(), EditorView.lineWrapping]}\n        basicSetup={{\n          closeBrackets: false,\n          lineNumbers: false,\n          highlightActiveLineGutter: false,\n          searchKeymap: false,\n          highlightActiveLine: false,\n          foldGutter: false,\n          bracketMatching: false,\n          syntaxHighlighting: false,\n        }}\n        width=\"100%\"\n        editable={!props.isDisabled}\n        indentWithTab={true}\n      />\n    </div>\n  );\n}\n","import React from 'react';\n\nimport { Button } from '@contentful/f36-components';\nimport tokens from '@contentful/f36-tokens';\nimport { css } from 'emotion';\n\nconst styles = {\n  toolbar: css({\n    display: 'flex',\n    alignItems: 'center',\n    padding: tokens.spacingXs,\n    justifyContent: 'space-between',\n    backgroundColor: tokens.gray100,\n    border: `1px solid ${tokens.gray200}`,\n    borderTopLeftRadius: tokens.borderRadiusSmall,\n    borderTopRightRadius: tokens.borderRadiusSmall,\n    borderBottom: 'none',\n  }),\n  title: css({\n    fontFamily: tokens.fontStackPrimary,\n    fontSize: tokens.fontSizeM,\n    color: tokens.gray600,\n  }),\n  actions: css({\n    button: {\n      marginLeft: tokens.spacingS,\n    },\n  }),\n};\n\ntype JsonEditorToolbarProps = {\n  isUndoDisabled: boolean;\n  isRedoDisabled: boolean;\n  onRedo: () => void;\n  onUndo: () => void;\n};\n\nexport function JsonEditorToolbar(props: JsonEditorToolbarProps) {\n  return (\n    <div className={styles.toolbar}>\n      <div className={styles.title}>JSON Editor</div>\n      <div className={styles.actions}>\n        <Button\n          variant=\"secondary\"\n          size=\"small\"\n          isDisabled={props.isUndoDisabled}\n          testId=\"json-editor-undo\"\n          onClick={() => {\n            props.onUndo();\n          }}>\n          Undo\n        </Button>\n        <Button\n          variant=\"secondary\"\n          size=\"small\"\n          isDisabled={props.isRedoDisabled}\n          testId=\"json-editor-redo\"\n          onClick={() => {\n            props.onRedo();\n          }}>\n          Redo\n        </Button>\n      </div>\n    </div>\n  );\n}\n","import React from 'react';\nimport { css } from 'emotion';\nimport tokens from '@contentful/f36-tokens';\nimport { ValidationMessage } from '@contentful/f36-components';\n\nexport function JsonInvalidStatus() {\n  return (\n    <div\n      role=\"status\"\n      data-test-id=\"json-editor.invalid-json\"\n      className={css({ marginTop: tokens.spacingS })}>\n      <ValidationMessage>This is not valid JSON</ValidationMessage>\n    </div>\n  );\n}\n","import { JSONObject } from './types';\n\nexport function stringifyJSON(obj: JSONObject | null | undefined): string {\n  if (obj === null || obj === undefined) {\n    return '';\n  } else {\n    return JSON.stringify(obj, null, 4);\n  }\n}\n\nexport function isValidJson(str: string) {\n  let parsed;\n  try {\n    parsed = JSON.parse(str);\n  } catch (e) {\n    return false;\n  }\n  // An object or array is valid JSON\n  if (typeof parsed !== 'object') {\n    return false;\n  }\n  return true;\n}\n\nexport function parseJSON(str: string): { valid: boolean; value?: JSONObject } {\n  if (str === '') {\n    return {\n      value: undefined,\n      valid: true,\n    };\n  } else if (isValidJson(str)) {\n    return {\n      value: JSON.parse(str),\n      valid: true,\n    };\n  } else {\n    return {\n      value: undefined,\n      valid: false,\n    };\n  }\n}\n","import * as React from 'react';\n\nimport { FieldAPI, FieldConnector } from '@contentful/field-editor-shared';\nimport deepEqual from 'deep-equal';\nimport throttle from 'lodash/throttle';\n\nimport { JsonEditorField } from './JsonEditorField';\nimport { JsonEditorToolbar } from './JsonEditorToolbar';\nimport { JsonInvalidStatus } from './JsonInvalidStatus';\nimport { JSONObject } from './types';\nimport { stringifyJSON, parseJSON } from './utils';\n\nexport interface JsonEditorProps {\n  /**\n   * is the field disabled initially\n   */\n  isInitiallyDisabled: boolean;\n\n  /**\n   * sdk.field\n   */\n  field: FieldAPI;\n}\n\ntype NullableJsonObject = JSONObject | null | undefined;\n\ntype ConnectedJsonEditorProps = {\n  initialValue: NullableJsonObject;\n  setValue: (value: NullableJsonObject) => void;\n  disabled: boolean;\n};\n\ntype ConnectedJsonEditorState = {\n  value: string;\n  isValidJson: boolean;\n  undoStack: string[];\n  redoStack: string[];\n  lastUndo: string;\n};\n\nclass ConnectedJsonEditor extends React.Component<\n  ConnectedJsonEditorProps,\n  ConnectedJsonEditorState\n> {\n  static defaultProps = {\n    isInitiallyDisabled: true,\n  };\n\n  constructor(props: ConnectedJsonEditorProps) {\n    super(props);\n    this.state = {\n      value: stringifyJSON(props.initialValue),\n      isValidJson: true,\n      undoStack: [],\n      redoStack: [],\n      lastUndo: '',\n    };\n  }\n\n  setValidJson = (value: boolean) => {\n    this.setState({\n      isValidJson: value,\n    });\n  };\n\n  pushUndo = throttle((value: string) => {\n    this.setState((state) => ({\n      undoStack: [...state.undoStack, value],\n    }));\n  }, 400);\n\n  onChange = (value: string) => {\n    const parsed = parseJSON(value);\n\n    if (value !== this.state.lastUndo) {\n      this.pushUndo(this.state.value);\n    }\n\n    this.setState({\n      value,\n      isValidJson: parsed.valid,\n    });\n\n    if (parsed.valid) {\n      this.props.setValue(parsed.value);\n    }\n  };\n\n  onUndo = () => {\n    const undoStack = this.state.undoStack;\n\n    if (undoStack.length === 0) {\n      return;\n    }\n\n    const value = undoStack.pop() || '';\n\n    const parsedValue = parseJSON(value);\n\n    this.setState(\n      (state) => ({\n        ...state,\n        value,\n        isValidJson: parsedValue.valid,\n        undoStack,\n        redoStack: [...state.redoStack, state.value],\n        lastUndo: value,\n      }),\n      () => {\n        if (parsedValue.valid) {\n          this.props.setValue(parsedValue.value);\n        }\n      }\n    );\n  };\n\n  onRedo = () => {\n    const redoStack = [...this.state.redoStack];\n\n    if (redoStack.length === 0) {\n      return;\n    }\n\n    const value = redoStack.pop() || '';\n\n    const parsedValue = parseJSON(value);\n\n    this.setState(\n      (state) => ({\n        ...state,\n        value,\n        isValidJson: parsedValue.valid,\n        redoStack,\n        undoStack: [...state.undoStack, state.value],\n      }),\n      () => {\n        if (parsedValue.valid) {\n          this.props.setValue(parsedValue.value);\n        }\n      }\n    );\n  };\n\n  render() {\n    return (\n      <div data-test-id=\"json-editor\">\n        <JsonEditorToolbar\n          isRedoDisabled={this.props.disabled || this.state.redoStack.length === 0}\n          isUndoDisabled={this.props.disabled || this.state.undoStack.length === 0}\n          onUndo={this.onUndo}\n          onRedo={this.onRedo}\n        />\n        <JsonEditorField\n          value={this.state.value}\n          onChange={this.onChange}\n          isDisabled={this.props.disabled}\n        />\n        {!this.state.isValidJson && <JsonInvalidStatus />}\n      </div>\n    );\n  }\n}\n\nexport default function JsonEditor(props: JsonEditorProps) {\n  return (\n    <FieldConnector<JSONObject>\n      field={props.field}\n      isInitiallyDisabled={props.isInitiallyDisabled}\n      isEqualValues={(value1, value2) => {\n        return deepEqual(value1, value2);\n      }}>\n      {({ value, disabled, setValue, externalReset }) => {\n        return (\n          <ConnectedJsonEditor\n            // on external change reset component completely and init with initial value again\n            key={`json-editor-${externalReset}`}\n            initialValue={value}\n            disabled={disabled}\n            setValue={setValue}\n          />\n        );\n      }}\n    </FieldConnector>\n  );\n}\n"],"names":["styles","root","css","cursor","padding","tokens","spacingS","border","gray200","borderTop","borderBottomLeftRadius","borderRadiusSmall","borderBottomRightRadius","fontSize","fontSizeM","color","gray900","outline","fontFamily","fontStackMonospace","minHeight","backgroundColor","gray100","JsonEditorField","props","React","className","cx","disabled","isDisabled","CodeMirror","value","onChange","theme","extensions","json","EditorView","lineWrapping","basicSetup","closeBrackets","lineNumbers","highlightActiveLineGutter","searchKeymap","highlightActiveLine","foldGutter","bracketMatching","syntaxHighlighting","width","editable","indentWithTab","toolbar","display","alignItems","spacingXs","justifyContent","borderTopLeftRadius","borderTopRightRadius","borderBottom","title","fontStackPrimary","gray600","actions","button","marginLeft","JsonEditorToolbar","Button","variant","size","isUndoDisabled","testId","onClick","onUndo","isRedoDisabled","onRedo","JsonInvalidStatus","role","marginTop","ValidationMessage","parseJSON","str","undefined","valid","parsed","JSON","parse","e","isValidJson","ConnectedJsonEditor","obj","setValidJson","setState","pushUndo","throttle","state","undoStack","_this","lastUndo","setValue","length","pop","parsedValue","redoStack","initialValue","stringify","render","this","defaultProps","isInitiallyDisabled","FieldConnector","field","isEqualValues","value1","value2","deepEqual","key","externalReset"],"mappings":"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"}